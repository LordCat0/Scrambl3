if(!("JSZip"in window))throw new Error("JSZip library not found!");var JSZip=new JSZip;function replaceCustomBlockId(e,s){const o=/^%[a-zA-Z0-9]+$/,t=e.split(/(%[a-zA-Z0-9]+)/);for(let e=0;e<t.length;e++)if(!o.test(t[e])&&t[e].trim().length>0){const o=t[e].match(/^\s*/)[0],n=t[e].match(/\s*$/)[0];t[e]=o+s+n}return t.join("")}function transformBlock(e,s){const o=[],t=JSON.parse(e.mutation.argumentnames);for(let e=0;e<t.length;e++){const n=s.CustomBlocks.args[t[e]]?s.CustomBlocks.args[t[e]]:`arg_${RandomNumber()}`;s.CustomBlocks.args[t[e]]=n,o.push(n)}return'["'+o.join('","')+'"]'}function RandomNumber(){return(Math.floor(99999*Math.random())+1).toString().padStart(5,"0")}async function ProcessFile(e){const s=await e.arrayBuffer(),o=await JSZip.loadAsync(s);if(!o.file("project.json"))return void Output("project.json not found in zip","Error");const t=JSON.parse(await o.file("project.json").async("string"));return o.file("project.json",JSON.stringify(ProcessJson(t))),o.generateAsync({type:"blob"})}function ProcessJson(e){const s=[...document.querySelectorAll('input[type="checkbox"]:checked')].map((e=>e.id));if(0!=e.extensions.length&&!confirm("This project uses extensions, which are not yet fully supported. Are you sure you want to continue?"))return;let o={Sprites:{},Variables:{},Lists:{},CustomBlocks:{}};o.CustomBlocks.args={},o.CustomBlocks.calls={},o.Broadcasts={},o.Sounds={};const t=e.targets;if(s.includes("ChangeSprites"))for(let e of t)if(!e.isStage){let s=`Spr_${RandomNumber()}`;o.Sprites[e.name]=s,e.name=s}if(s.includes("ChangeVar")){for(let e of t)for(let s in e.variables){let t=`Var_${RandomNumber()}`;const n=e.variables[s];o.Variables[n[0]]=t,n[0]=t}for(let s in e.monitors){const t=e.monitors[s];"data_variable"==t.opcode&&o.Variables[t.params.VARIABLE]&&(t.params.VARIABLE=o.Variables[t.params.VARIABLE])}}for(let e of t){if(e.isStage){for(let s in e.comments)e.comments[s].text.endsWith("// _twconfig_")||delete e.comments[s];e.comments.a={x:0,y:0,width:628,height:121,minimized:!1,text:"This project was obfuscated by Sb3 Obfuscator!\n\nhttp://127.0.0.1:5500/index.html"}}else e.comments={};if(Output(`Processing Sprite: ${e.isStage?"Stage":s.includes("ChangeSprites")?Object.keys(o.Sprites).find((s=>o.Sprites[s]==e.name)):e.name}`,"Title"),s.includes("ChangeList"))for(let s in e.lists){let t=`List_${RandomNumber()}`;const n=e.lists[s];o.Lists[n[0]]=t,n[0]=t}if(s.includes("ChangeBroadcasts"))for(let s in e.broadcasts){let t=`Msg_${RandomNumber()}`;o.Broadcasts[e.broadcasts[s].toLowerCase()]=t,e.broadcasts[s]=t}if(s.includes("ChangeSounds"))for(let s of e.sounds){let e=`Snd_${RandomNumber()}`;o.Sounds[s.name]=e,s.name=e}for(let t in e.blocks){const n=e.blocks[t];if("procedures_prototype"==n.opcode&&s.includes("ChangeCustomBlock")){const e=replaceCustomBlockId(n.mutation.proccode,`func_${RandomNumber()}`);o.CustomBlocks.calls[n.mutation.proccode]=e,n.mutation.proccode=e,n.mutation.argumentnames=transformBlock(n,o)}}for(let t in e.blocks){const n=e.blocks[t];n.x=0,n.y=0,"looks_costume"==n.opcode&&s.includes("ChangeCostumes")&&o.Costumes[n.fields.COSTUME[0]]&&(n.fields.COSTUME[0]=o.Costumes[n.fields.COSTUME[0]]),"looks_backdrops"==n.opcode&&s.includes("ChangeCostumes")&&o.Costumes[n.fields.BACKDROP[0]]&&(n.fields.BACKDROP[0]=o.Costumes[n.fields.BACKDROP[0]]),"sound_sounds_menu"==n.opcode&&s.includes("ChangeSounds")&&o.Sounds[n.fields.SOUND_MENU[0]]&&(n.fields.SOUND_MENU[0]=o.Sounds[n.fields.SOUND_MENU[0]]),"procedures_call"==n.opcode&&s.includes("ChangeCustomBlock")&&o.CustomBlocks.calls[n.mutation.proccode]&&(n.mutation.proccode=o.CustomBlocks.calls[n.mutation.proccode]),"argument_reporter_string_number"!=n.opcode&&"argument_reporter_boolean"!=n.opcode||!s.includes("ChangeCustomBlock")||o.CustomBlocks.args[n.fields.VALUE[0]]&&(n.fields.VALUE[0]=o.CustomBlocks.args[n.fields.VALUE[0]]),"sensing_of"==n.opcode&&s.includes("ChangeVar")&&o.Variables[n.fields.PROPERTY[0]]&&(n.fields.PROPERTY[0]=o.Variables[n.fields.PROPERTY[0]]),"motion_pointtowards_menu"==n.opcode&&s.includes("ChangeSprites")&&o.Sprites[n.fields.TOWARDS[0]]&&(n.fields.TOWARDS[0]=o.Sprites[n.fields.TOWARDS[0]]),"motion_goto_menu"!=n.opcode&&"motion_glideto_menu"!=n.opcode||!s.includes("ChangeSprites")||o.Sprites[n.fields.TO[0]]&&(n.fields.TO[0]=o.Sprites[n.fields.TO[0]]),"control_create_clone_of_menu"==n.opcode&&s.includes("ChangeSprites")&&o.Sprites[n.fields.CLONE_OPTION[0]]&&(n.fields.CLONE_OPTION[0]=o.Sprites[n.fields.CLONE_OPTION[0]]),"sensing_of_object_menu"==n.opcode&&s.includes("ChangeSprites")&&o.Sprites[n.fields.OBJECT[0]]&&(n.fields.OBJECT[0]=o.Sprites[n.fields.OBJECT[0]]),"sensing_distancetomenu"==n.opcode&&s.includes("ChangeSprites")&&o.Sprites[n.fields.DISTANCETOMENU[0]]&&(n.fields.DISTANCETOMENU[0]=o.Sprites[n.fields.DISTANCETOMENU[0]]),"sensing_touchingobjectmenu"==n.opcode&&s.includes("ChangeSprites")&&o.Sprites[n.fields.TOUCHINGOBJECTMENU[0]]&&(n.fields.TOUCHINGOBJECTMENU[0]=o.Sprites[n.fields.TOUCHINGOBJECTMENU[0]]),"event_whenbroadcastreceived"==n.opcode&&s.includes("ChangeBroadcasts")&&(console.log(!!o.Broadcasts[n.fields.BROADCAST_OPTION[0].toLowerCase()],n.fields.BROADCAST_OPTION[0].toLowerCase(),o.Broadcasts[n.fields.BROADCAST_OPTION[0].toLowerCase()]),o.Broadcasts[n.fields.BROADCAST_OPTION[0]]&&(n.fields.BROADCAST_OPTION[0]=o.Broadcasts[n.fields.BROADCAST_OPTION[0]])),"event_broadcast"!=n.opcode&&"event_broadcastandwait"!=n.opcode||!s.includes("ChangeBroadcasts")||(console.log(!!o.Broadcasts[n.inputs.BROADCAST_INPUT[1][1].toLowerCase()],n.inputs.BROADCAST_INPUT[1][1].toLowerCase(),o.Broadcasts[n.inputs.BROADCAST_INPUT[1][1].toLowerCase()]),o.Broadcasts[n.inputs.BROADCAST_INPUT[1][1]]&&(n.inputs.BROADCAST_INPUT[1][1]=o.Broadcasts[n.inputs.BROADCAST_INPUT[1][1]])),n.fields&&n.fields.LIST&&s.includes("ChangeList")&&o.Lists[n.fields.LIST[0]]&&(n.fields.LIST[0]=o.Lists[n.fields.LIST[0]])}}return console.log(o),e}